# Ralph Progress Log
Started: 2026-02-16
Branch: ralph/gradethread-build
---

## Foundation (US-001 through US-021)
- Status: COMPLETE (pre-built before Ralph)
- 21 stories covering: Vite scaffold, Tailwind/shadcn, TypeScript types, Supabase client, auth layer, routing, layouts, dashboard shell, all pages, static assets, DB migration, edge functions, CF config
- Notes: Built manually in initial foundation session. All typecheck and build passing.
---

## US-022: Database migration: add inventory and financial tracking tables
- Status: COMPLETE
- Files changed: supabase/migrations/00002_inventory_financial.sql, prd.json, scripts/ralph/prd.json
- Notes: Created migration with 2 new enums (item_status, listing_platform), 4 new tables (inventory_items, listings, sales, shipments). All tables have UUID PKs, proper FK constraints (CASCADE on delete, SET NULL for optional refs), indexes on all FKs and status columns, RLS policies enforcing ownership through the inventory_items -> user_id chain, and set_updated_at triggers on tables with updated_at columns. Sales table intentionally has no updated_at (immutable records). Shipments RLS uses a JOIN through sales to inventory_items for ownership verification.
- Timestamp: 2026-02-16
---

## US-023: TypeScript types for inventory and financial tables
- Status: COMPLETE
- Files changed: src/types/database.ts, prd.json, scripts/ralph/prd.json
- Notes: Added ItemStatus (8 values) and ListingPlatform (8 values) enum types. Created Row, Insert, and Update types for inventory_items, listings, sales, and shipments tables. Updated Database interface with 4 new table entries in public.Tables and 2 new enum entries in public.Enums. All nullable SQL columns mapped to `T | null`. Insert types have optional fields for columns with DB defaults. Sales has no updated_at (immutable records per migration design). Typecheck and build pass clean.
- Timestamp: 2026-02-16
---

## US-024: Database migration: admin tables and roles
- Status: COMPLETE
- Files changed: supabase/migrations/00003_admin_tables.sql, src/types/database.ts, prd.json, scripts/ralph/prd.json
- Notes: Created user_role enum (user/reviewer/admin/super_admin), added role column to users table (default 'user'). Three new tables: admin_audit_log (for tracking admin actions), human_reviews (for reviewer overrides on low-confidence grades), ai_prompt_versions (for tracking AI prompt iterations and accuracy). Created is_admin() and is_reviewer_or_admin() SECURITY DEFINER helper functions for RLS. RLS policies: audit log admin-only, human reviews admin+reviewer, prompt versions admin-only (full CRUD). Added indexes on all FKs, action/target_type columns, and users.role. TypeScript types updated with UserRole enum, role on UserRow/UserInsert, and Row/Insert/Update types for all 3 new tables plus Database interface entries.
- Timestamp: 2026-02-16
---

## US-025: TypeScript types for admin tables
- Status: COMPLETE
- Files changed: scripts/ralph/prd.json, prd.json
- Notes: All acceptance criteria were already satisfied by the US-024 implementation which added UserRole enum, UserRow.role field, Row/Insert/Update types for admin_audit_log, human_reviews, and ai_prompt_versions, plus Database interface entries and UserRole enum registration. Verified typecheck and build pass. No code changes needed — only prd.json updates to mark story as passing.
- Timestamp: 2026-02-16
---

## US-026: Image upload utility with Supabase Storage
- Status: COMPLETE
- Files changed: src/lib/storage.ts, prd.json, scripts/ralph/prd.json, scripts/ralph/progress.txt
- Notes: Created storage utility module with three exported functions: uploadSubmissionImage (validates file type/size, uploads to {userId}/{submissionId}/{imageType}_{timestamp}.{ext}), getImageUrl (creates signed URLs with 1hr expiry), deleteSubmissionImage (removes files from bucket). Validates against MIME types (jpeg/png/webp) and 10MB size limit matching the DB bucket config. All errors throw with meaningful messages. Typecheck and build pass clean.
- Timestamp: 2026-02-16
---

## US-027: Client-side image compression and validation
- Status: COMPLETE
- Files changed: src/lib/image-utils.ts, prd.json, scripts/ralph/prd.json, scripts/ralph/progress.txt
- Notes: Created image-utils module with two exported functions: validateImage(file) checks MIME type (jpeg/png/webp), file size (10MB max), and resolution (min 1200x1200px), returning structured validation errors with user-friendly messages. compressImage(file, maxWidth, quality) uses canvas API to resize images (default max 2400px wide), compress (default 0.85 quality), and correct EXIF orientation by parsing the orientation tag from the first 64KB of JPEG files. Handles all 8 EXIF orientation values including dimension swaps for rotated images. Outputs WebP for JPEG/WebP inputs, preserves PNG format. Typecheck and build pass clean.
- Timestamp: 2026-02-16
---

## US-028: Edge function: JWT auth middleware
- Status: COMPLETE
- Files changed: services/edge-functions/src/middleware/auth.ts, services/edge-functions/src/main.ts, prd.json, scripts/ralph/prd.json, scripts/ralph/progress.txt
- Notes: Created Hono middleware that extracts Bearer token from Authorization header, validates it via supabase.auth.getUser(), and sets user and userId on the Hono context. Returns 401 JSON error for missing or invalid tokens. Applied to /api/grade/* routes in main.ts using app.use() path matching. Health and webhook routes remain unprotected as required. Uses createMiddleware from hono/factory with typed Variables for user and userId.
- Timestamp: 2026-02-16
---

## US-029: Edge function: rate limiting middleware
- Status: COMPLETE
- Files changed: services/edge-functions/src/middleware/rate-limit.ts, services/edge-functions/src/main.ts, prd.json, scripts/ralph/prd.json, scripts/ralph/progress.txt
- Notes: Created rateLimiter(maxRequests, windowMs) factory function that returns Hono middleware. Uses in-memory Map keyed by userId from auth context. Tracks request count and window reset time per user. Returns 429 with Retry-After header and JSON error body when limit exceeded. Includes periodic cleanup of expired entries (every 5 minutes). Adds standard X-RateLimit-Limit, X-RateLimit-Remaining, and X-RateLimit-Reset headers to all responses. Applied to /api/grade/* routes after auth middleware with default 60 requests per 60 seconds. Skips rate limiting if no userId is available in context.
- Timestamp: 2026-02-16
---

## US-030: Photo upload UI component with drag-and-drop
- Status: COMPLETE
- Files changed: src/components/submission/photo-upload.tsx, prd.json, scripts/ralph/prd.json, scripts/ralph/progress.txt
- Notes: Created PhotoUpload component with 8 upload slots (front, back, label, detail required; detail 2, defect 1-3 optional). Each slot shows icon (Shirt/Tag/Search/AlertTriangle from lucide-react), label, required indicator, and description. Supports drag-and-drop (onDragOver/onDrop) and click-to-select (hidden file input). Shows image preview with hover-reveal remove button. Validates via existing validateImage (type/size/resolution) and compresses via compressImage before emitting. Emits onChange with PhotoUploadItem[] ({file, imageType, preview}). Responsive grid: 2 cols mobile, 4 cols desktop. Used Map<string, SlotState> instead of Record for strict TypeScript compatibility. Processing spinner shown during validation/compression.
- Timestamp: 2026-02-16
---

## US-031: Submission wizard: step 1 - garment info form
- Status: COMPLETE
- Files changed: src/components/submission/garment-info-form.tsx, src/components/ui/select.tsx (shadcn), src/components/ui/textarea.tsx (shadcn), prd.json, scripts/ralph/prd.json
- Notes: Created GarmentInfoForm component with garment type select (GARMENT_TYPES), category select (GARMENT_CATEGORIES filtered by type via CATEGORY_BY_TYPE mapping), brand input (optional), title input (required, max 100 chars with counter), description textarea (optional, max 500 chars with counter). Form validation shows inline error messages for required fields. onSubmit passes validated GarmentInfo to parent. Supports defaultValues prop for state persistence. Added shadcn select and textarea components via npx shadcn@latest add.
- Timestamp: 2026-02-16
---

## US-032: Submission wizard: multi-step container with progress
- Status: COMPLETE
- Files changed: src/pages/new-submission.tsx (new), src/routes/index.tsx, prd.json, scripts/ralph/prd.json
- Notes: Created 3-step submission wizard at /dashboard/submissions/new. StepIndicator component shows numbered circles with checkmarks for completed steps and connecting lines. Step 1 renders GarmentInfoForm with defaultValues for state persistence when navigating back. Step 2 renders PhotoUpload with Back/Next buttons (Next disabled until all 4 required photos uploaded). Step 3 shows review with garment details grid, photo thumbnails grid, and pricing info from user's plan. All state (garmentInfo, photos) persisted in parent component via useState so navigating back preserves data. Route added to router inside protected dashboard layout.
- Timestamp: 2026-02-16
---

## US-033: Submission creation API endpoint
- Status: COMPLETE
- Files changed: services/edge-functions/src/routes/grade.ts, supabase/migrations/00004_increment_grades_function.sql, prd.json, scripts/ralph/prd.json
- Notes: Fully implemented POST /api/grade/submit endpoint with multipart form data parsing. Validates garment_type, garment_category, title (required), and image files (requires front, back, label, and at least 1 detail image). Checks user's grade usage against plan limits (free:5, starter:50, professional:500, enterprise:unlimited) with monthly reset logic. Creates submission record with status 'pending', uploads each image to Supabase storage under {userId}/{submissionId}/{imageType}_{timestamp}.{ext}, creates submission_image records with display_order. Increments grades_used_this_month via Postgres RPC function (new migration 00004) or resets counter if month rolled over. Returns 201 with { submissionId, status } on success, 403 with upgrade message if limit exceeded, 400 with detailed validation errors for invalid input. Also implemented GET /status/:id endpoint scoped to authenticated user. Includes cleanup logic on failure (deletes uploaded images and submission record).
- Timestamp: 2026-02-16
---

## US-034: Claude Vision API integration for per-image analysis
- Status: COMPLETE
- Files changed: services/edge-functions/src/lib/ai-grading.ts (new), prd.json, scripts/ralph/prd.json
- Notes: Created ai-grading.ts module exporting analyzeImage(imageUrl, imageType, garmentType) function and typed interfaces (PerImageAnalysis, DetectedIssue, ConditionSignal, FactorScores). Uses Anthropic SDK v0.24.1 with base64 image source (parseImageInput helper handles data URI and raw base64 formats). System prompt establishes expert clothing condition assessor role with grading scale and 5 weighted factors. User prompt includes image-type-specific context (front/back/label/detail/defect) and garment-type-specific criteria (tops/bottoms/outerwear/dresses/footwear/accessories). Requests structured JSON with detected_issues[], condition_signals[], and estimated_scores per factor. Response parsing strips markdown code fences, validates structure, and clamps scores to 1.0-10.0 range. Error handling covers timeouts, rate limits, and parse failures with contextual error messages. Logs API usage (input/output tokens, latency) for monitoring.
- Timestamp: 2026-02-16
---

## US-035: Claude Vision API: composite grading from all images
- Status: COMPLETE
- Files changed: services/edge-functions/src/lib/ai-grading.ts, prd.json, scripts/ralph/prd.json
- Notes: Added compositeGrade(perImageResults[], garmentInfo) function to ai-grading.ts. Exports new types: CompositeGradeResult, GarmentInfo, DefectFound. Sends all per-image analyses as structured JSON input to Claude with comprehensive composite system prompt including full grade tier definitions (NWT through Salvage with score ranges and descriptions). Applies factor weights (fabric 30%, structural 25%, cosmetic 20%, functional 15%, odor 10%) and recalculates weighted average server-side for authoritative scoring. Rounds overall_score to nearest 0.5 increment. Derives grade_tier deterministically from calculated score via scoreToGradeTier(). Validates and clamps all factor scores (1.0-10.0), confidence (0.0-1.0). Sets needs_human_review flag when confidence < 0.75. Includes prompt_version field ("composite_v1") referencing ai_prompt_versions concept. Validates defects_found array entries for required fields and valid severity values. Comprehensive error handling for timeouts, rate limits, and parse failures with API usage logging.
- Timestamp: 2026-02-16
---

## US-036: Grade calculation and report creation pipeline
- Status: COMPLETE
- Files changed: services/edge-functions/src/lib/grading-pipeline.ts (new), prd.json, scripts/ralph/prd.json
- Notes: Created processSubmission(submissionId) orchestration function that runs the full grading pipeline. Fetches submission record and validates status is 'pending', sets status to 'processing'. Fetches associated submission_images, downloads each from Supabase Storage, converts Blob to base64 data URI with correct MIME type detection from file extension. Runs analyzeImage() on all images in parallel via Promise.all. Runs compositeGrade() with per-image results and garment info. Creates grade_report record with all factor scores, AI summary, confidence score, model version, and a UUID certificate_id generated via crypto.randomUUID(). Builds detailed_notes object from per-image issue/signal summaries plus defects summary. Updates submission status to 'completed' on success. Full try/catch wraps entire pipeline — on failure, logs error and updates submission status to 'failed' (with nested try/catch to handle status update failures). Comprehensive console logging at each pipeline stage with timing metrics.
- Timestamp: 2026-02-16
---

## US-037: Trigger grading pipeline on submission creation
- Status: COMPLETE
- Files changed: services/edge-functions/src/routes/grade.ts, services/edge-functions/src/lib/grading-pipeline.ts, prd.json, scripts/ralph/prd.json
- Notes: Updated POST /api/grade/submit to set status to 'processing' after image upload and trigger processSubmission() as fire-and-forget with .catch() error handler. Response now returns status 'processing' instead of 'pending'. Updated GET /api/grade/status/:id to return { id, status, grade_report, created_at, updated_at } — fetches from grade_reports table when status is 'completed', returns null otherwise. Updated processSubmission() to accept both 'pending' and 'processing' statuses (since submit endpoint now sets 'processing' before calling the pipeline). Typecheck and build pass clean.
- Timestamp: 2026-02-16
---

## US-038: Submission detail page with grade report display
- Status: COMPLETE
- Files changed: src/pages/submission-detail.tsx, src/components/ui/skeleton.tsx (shadcn), src/components/ui/progress.tsx (shadcn), prd.json, scripts/ralph/prd.json
- Notes: Fully rebuilt submission-detail.tsx from placeholder to complete grade report page. Features: loading skeleton while fetching, garment info card (title/brand/type/category), large circular overall score with color-coded tier badge (green >7, yellow 5-7, red <5), factor breakdown with 5 labeled progress bars showing weights, AI analysis summary card, confidence indicator (high/medium/low with icons), detected issues as badges or bullet points from detailed_notes, image gallery with signed URLs from Supabase Storage, share certificate button linking to /cert/:certificateId, status-aware states (processing spinner, failed error, pending info). Added shadcn skeleton and progress components. Used type assertion for submission_images query due to tsc -b type inference resolving data to 'never' despite correct Database interface definition.
- Timestamp: 2026-02-16
---

## US-039: Submissions list page with filtering and pagination
- Status: COMPLETE
- Files changed: src/pages/submissions.tsx, src/components/ui/table.tsx (shadcn), prd.json, scripts/ralph/prd.json
- Notes: Replaced placeholder submissions page with full implementation. Table displays title, brand, status badge (color-coded), grade score (with color), and date submitted. Filter controls for status (all/pending/processing/completed/failed/disputed) and garment type (all 6 types). Sort by date (default newest first) or grade with toggle direction. Pagination with 20 items per page, page number display, previous/next buttons. Click row navigates to /dashboard/submissions/:id. Empty state with CTA button to create first submission. Loading skeleton while fetching. Uses TanStack Query with queryKey including all filter/sort/page params and 5-minute stale time. Fetches grade reports for completed submissions in a second query and merges results. Type assertions used for Supabase query results due to tsc -b type resolution issue.
- Timestamp: 2026-02-16
---

## US-040: Stripe checkout session creation for grade payments
- Status: COMPLETE
- Files changed: services/edge-functions/src/routes/payments.ts (new), services/edge-functions/src/main.ts, scripts/ralph/prd.json, prd.json
- Notes: Created new payments route file with POST /checkout-session endpoint. Accepts { submissionId, tier } JSON body. Three tiers: standard ($2.99/299 cents), premium ($7.99/799 cents), express ($12.99/1299 cents). Validates tier is valid, validates user owns the submission via Supabase query. Creates Stripe Checkout Session with mode:payment, price_data with product name/description, and metadata containing submission_id, user_id, and tier for webhook processing. Success URL redirects to /dashboard/submissions/:id?payment=success, cancel URL to /dashboard/submissions?payment=cancelled. Returns { sessionId, url }. Registered route in main.ts at /api/payments with auth middleware applied.
- Timestamp: 2026-02-16
---

## US-041: Stripe webhook handling for payment events
- Status: COMPLETE
- Files changed: services/edge-functions/src/routes/webhooks.ts, scripts/ralph/prd.json, prd.json
- Notes: Replaced stub webhook handler with full Stripe webhook implementation. Verifies webhook signature using stripe.webhooks.constructEvent with STRIPE_WEBHOOK_SECRET env var. Handles 4 event types: (1) checkout.session.completed — reads submission_id/user_id from session metadata, marks submission payment_status as paid, triggers grading pipeline fire-and-forget; (2) customer.subscription.created/updated — finds user by stripe_customer_id, maps subscription to plan tier via metadata/lookup_key/price amount, updates user plan; (3) customer.subscription.deleted — downgrades user to free plan; (4) invoice.payment_failed — logs event with user context for debugging. Returns 200 for all handled events (including handler errors to prevent retries), 400 for signature verification failures. All events logged with [Webhook] prefix.
- Timestamp: 2026-02-16
---

## US-042: Subscription management page (billing)
- Status: COMPLETE
- Files changed: src/pages/billing.tsx, services/edge-functions/src/routes/payments.ts, scripts/ralph/prd.json, prd.json
- Notes: Fully rebuilt billing.tsx with plan comparison grid showing all 4 plans (Free, Starter $29/mo, Professional $99/mo, Enterprise custom). Current plan card shows feature list, usage progress bar (grades used / limit), and grade reset date with CalendarClock icon. Current plan highlighted with border-brand-navy border. Upgrade buttons call POST /api/payments/subscribe to create Stripe Checkout subscription sessions. Manage Subscription button calls POST /api/payments/portal to open Stripe Customer Portal for existing subscribers with stripe_customer_id. Enterprise plan directs to sales email. Added two new edge function endpoints: /subscribe (creates subscription checkout with existing customer or customer_email) and /portal (creates billing portal session). Downgrade handled via portal. All loading states with Loader2 spinner, errors via sonner toast.
- Timestamp: 2026-02-16
---

## US-043: Grade certificate public page
- Status: COMPLETE
- Files changed: src/pages/certificate.tsx, package.json, package-lock.json, scripts/ralph/prd.json, prd.json
- Notes: Fully rebuilt certificate.tsx as a public-facing grade certificate page. Fetches grade report by certificate_id via Supabase (public RLS). Shows GradeThread branding header with logo_white.svg and Shield icon. Displays overall score in a large circle with tier badge and color coding. Shows garment photos in a responsive grid gallery with signed URLs. Factor breakdown with 5 horizontal Progress bars matching submission-detail patterns. AI summary section. Footer with graded date (Calendar icon), model version (Cpu icon), certificate ID. QR code via qrcode.react (QRCodeSVG) linking back to the certificate URL in brand navy color. OG meta tags set dynamically via useEffect. Loading skeleton and "Certificate not found" error state. Mobile-responsive layout throughout.
- Timestamp: 2026-02-16
---

## US-044: Dashboard overview: live data integration
- Status: COMPLETE
- Files changed: src/pages/dashboard.tsx, prd.json, scripts/ralph/prd.json
- Notes: Replaced placeholder dashboard with live data integration. Fetches real submission count and last 5 recent submissions from Supabase via TanStack Query (5-min stale time). Recent submissions show title, date, status badge (color-coded), and grade score for completed items. Clicking a submission navigates to /dashboard/submissions/:id. Added "New Submission" CTA button in header linking to /dashboard/submissions/new. "View All" button links to submissions list. Empty state with CTA when no submissions exist. Total Submissions card shows live count with loading skeleton. Grades Used card already uses live profile data (grades_used_this_month). Grade reports fetched for completed submissions and merged. Type assertions used for Supabase query results per tsc -b workaround.
- Timestamp: 2026-02-16
---

## US-045: Grade analytics charts on dashboard
- Status: COMPLETE
- Files changed: src/components/dashboard/grade-charts.tsx (new), src/pages/dashboard.tsx, package.json, package-lock.json, prd.json, scripts/ralph/prd.json
- Notes: Installed recharts library. Created GradeCharts component with 3 charts: (1) Grade Distribution bar chart showing count of grades in each tier bucket (NWT through Poor) with color-coded bars, (2) Average Grade Over Time line chart with 4 weekly data points over last 30 days using brand navy color, (3) Submissions by Garment Type donut pie chart with labels showing percentages. All charts use ResponsiveContainer for responsive sizing. Empty state shows centered message when no completed submissions exist. Loading state shows skeleton cards. Integrated into dashboard.tsx between stats cards and recent submissions. Fixed tsc -b strict type issues: Record indexing returns possibly-undefined values, recharts Tooltip formatter type incompatibility, and Pie label percent possibly undefined.
- Timestamp: 2026-02-16
---

## US-046: Export submissions as CSV
- Status: COMPLETE
- Files changed: src/pages/submissions.tsx, prd.json, scripts/ralph/prd.json
- Notes: Added Export CSV button (with Download icon) to submissions page header alongside New Submission button. Export function fetches all user submissions and their grade reports from Supabase (bypassing pagination), then builds a CSV with 14 columns: Submission Date, Title, Brand, Garment Type, Category, Status, Overall Grade, Grade Tier, Fabric Condition, Structural Integrity, Cosmetic Appearance, Functional Elements, Odor & Cleanliness, Certificate URL. CSV fields properly escaped for commas/quotes/newlines. File downloads as gradethread_export_{YYYY-MM-DD}.csv via Blob URL. Shows loading state on button during export. Empty submissions show info toast. Fixed tsc -b type issue by using .slice(0,10) instead of .split('T')[0] and explicit string[] array typing.
- Timestamp: 2026-02-16
---

## US-047: Settings page: profile editing
- Status: COMPLETE
- Files changed: src/pages/settings.tsx, src/hooks/use-auth.ts, prd.json, scripts/ralph/prd.json
- Notes: Rewrote settings page with full profile editing: editable full name input, avatar upload with FileReader preview and Supabase storage upload, read-only email display, save button that updates users table via .update(). Password change section for email/password users (hidden for OAuth) with current password verification via re-auth, new password + confirm fields, min 6 chars validation. Added refreshProfile() to useAuth hook to reload profile after save. Used 'as never' cast on .update() to work around tsc -b type resolution issue. All toasts via sonner.
- Timestamp: 2026-02-16
---

## US-048: Inventory management: items list page
- Status: COMPLETE
- Files changed: src/pages/inventory.tsx, src/routes/index.tsx, src/components/dashboard/sidebar.tsx, src/lib/constants.ts, prd.json, scripts/ralph/prd.json
- Notes: Created inventory list page with table displaying title, brand, status badge, grade, acquired price, listed price, and days in inventory columns. Added filters for status, garment type, and brand (brand filter dynamically populated from existing items). Sort by date, price, or status. 25-item pagination. Add Item button navigates to /dashboard/inventory/new. Row click navigates to /dashboard/inventory/:id. Added ITEM_STATUSES constant to constants.ts. Added Package icon sidebar nav link. Uses TanStack Query with 5-min stale time. Used explicit cast pattern for Supabase query results (consistent with tsc -b workaround).
- Timestamp: 2026-02-16
---

## US-049: Inventory management: add item form
- Status: COMPLETE
- Files changed: src/pages/inventory-add.tsx, src/routes/index.tsx, prd.json, scripts/ralph/prd.json
- Notes: Created inventory add form page at /dashboard/inventory/new with garment details (title, brand, garment type/category, size, color, condition notes) and acquisition details (price with $ prefix, date defaulting to today, source dropdown). Title and acquired price are required fields. Creates inventory_items record with status 'acquired' via Supabase insert. Two submit options: "Add to Inventory" navigates to item detail page, "Save & Submit for Grading" navigates to new submission page. Used InventoryItemInsert type with 'as never' cast for tsc -b compatibility.
- Timestamp: 2026-02-16
---

## US-050: Inventory item detail page with lifecycle timeline
- Status: COMPLETE
- Files changed: src/pages/inventory-detail.tsx (new), src/routes/index.tsx, prd.json, scripts/ralph/prd.json
- Notes: Created inventory detail page at /dashboard/inventory/:id. Features: header with title, brand, garment type/category and status badge. Lifecycle timeline component with 7 steps (acquired → grading → graded → listed → sold → shipped → completed) shown as connected circles with icons, current step highlighted with ring. Special "returned" state shown separately. Acquisition card with price, date, source, size, color, condition notes. Grading card with link to grade report if graded or Submit for Grading button. Listings section showing all listings with platform, price, date, active/inactive badge, external link. Sales section with sale price, platform fees, date, buyer. Shipments section with carrier, tracking, cost, dates. Profit/loss summary calculating net profit = sale revenue - acquired price - platform fees - shipping costs (green/red color coding). Edit status via dropdown select with all 8 statuses. Used 'as never' cast on .update() for tsc -b compatibility.
- Timestamp: 2026-02-16
---

## US-051: Inventory: add listing to item
- Status: COMPLETE
- Files changed: src/pages/inventory-detail.tsx, src/lib/constants.ts, prd.json, scripts/ralph/prd.json
- Notes: Added Add Listing dialog to inventory detail page with platform dropdown (8 platforms), listing price input, listing URL input (optional), and platform listing ID input (optional). Dialog creates listing record via Supabase insert and auto-updates item status to 'listed' when current status is 'graded' or 'acquired'. Added active/inactive toggle button on each listing row. Added LISTING_PLATFORMS constant to constants.ts and formatPlatform helper with proper display names (e.g. "eBay", "Facebook Marketplace"). Used 'as never' casts on Supabase .insert()/.update() for tsc -b compatibility. Multiple listings per item supported (cross-listing).
- Timestamp: 2026-02-16
---

## US-052: Inventory: record sale
- Status: COMPLETE
- Files changed: src/pages/inventory-detail.tsx, prd.json, scripts/ralph/prd.json
- Notes: Added Record Sale dialog to the Sales card on inventory detail page. Dialog includes: linked listing dropdown (shows active listings with platform name and price, or "No linked listing"), sale price input (required), platform fees input (default 0), sale date input (default today), buyer username input (optional). On submit: creates sale record in Supabase linked to inventory item and optional listing, marks ALL active listings for this item as inactive (cross-listing cleanup), updates item status to 'sold'. Used 'as never' cast on Supabase insert/update for tsc -b compatibility.
- Timestamp: 2026-02-16
---

## US-053: Inventory: record shipment
- Status: COMPLETE
- Files changed: src/pages/inventory-detail.tsx, prd.json, scripts/ralph/prd.json
- Notes: Added Record Shipment dialog to the Shipments card on inventory detail page. Dialog visible when item status is sold or shipped and sales exist. Features: carrier dropdown (USPS, UPS, FedEx, DHL, Other), tracking number input (optional), shipping cost input (required), label cost input (default 0 for pre-paid labels), ship date (default today), weight in oz (optional). Auto-selects sale when only one exists, shows sale selector for multiple sales. Creates shipment record linked to sale, updates item status to shipped. Mark as Delivered button on undelivered shipments sets delivery_date to today and updates item status to completed. Used 'as ShipmentRow' cast for tsc -b compatibility on spread operations.
- Timestamp: 2026-02-16
---

## US-054: Financial dashboard overview
- Status: COMPLETE
- Files changed: src/pages/finances.tsx (new), src/routes/index.tsx, src/components/dashboard/sidebar.tsx, prd.json, scripts/ralph/prd.json
- Notes: Created financial dashboard page at /dashboard/finances. Features 8 metric cards in two rows: Row 1 - Total Revenue, Total Costs, Net Profit, Profit Margin %. Row 2 - Items Sold, Avg Profit/Item, Avg Days to Sell, Inventory Value. Period toggle with 5 options (This Month, Last 30 Days, This Quarter, This Year, All Time) filters sales by date. Revenue = sum of sale prices, costs = acquisition + shipping + label + platform fees, inventory value = sum of acquired_price for unsold items (acquired/grading/graded/listed statuses). All data fetched via Supabase queries with loading skeletons. Color coding: green for revenue/positive profit, red for costs/losses. Used explicit type casts for tsc -b compatibility.
- Timestamp: 2026-02-16
---

## US-055: Financial reporting: profit/loss per item
- Status: COMPLETE
- Files changed: src/components/finances/profit-table.tsx (new), src/pages/finances.tsx, prd.json, scripts/ralph/prd.json
- Notes: Created ProfitTable component with all 10 required columns (Item Title, Brand, Acquired Price, Grading Cost, Listed Price, Sale Price, Platform Fees, Shipping Cost, Net Profit, Profit Margin %). All columns sortable via header buttons with directional arrows. Filters: date range (from/to date inputs), profit/loss toggle (Select dropdown), brand filter, category filter. Green/red color coding on Net Profit and Margin columns. Totals footer row sums all monetary columns and calculates aggregate margin. Added listings fetch to finances page data query for Listed Price column. Grading Cost column present as placeholder (0) since no grading fee field in DB yet.
- Timestamp: 2026-02-16
---

## US-056: Financial reporting: revenue and profit charts
- Status: COMPLETE
- Files changed: src/components/finances/financial-charts.tsx (new), src/pages/finances.tsx, prd.json, scripts/ralph/prd.json
- Notes: Created FinancialCharts component with 5 charts using recharts: (1) Revenue & Profit over time line chart with daily/weekly/monthly granularity toggle, (2) Cost breakdown pie chart (acquisition, shipping, platform fees, grading fees), (3) Top 5 brands by profit horizontal bar chart, (4) Top 5 categories by profit vertical bar chart. All charts respond to the period filter from the finances page. Used recharts Tooltip formatter pattern from grade-charts.tsx (Number(value) cast) to avoid tsc -b type errors.
- Timestamp: 2026-02-16
---

## US-057: Financial reporting: cash flow timeline
- Status: COMPLETE
- Files changed: src/components/finances/cash-flow.tsx (new), src/pages/finances.tsx, prd.json, scripts/ralph/prd.json
- Notes: Created CashFlow component with dual-view toggle (chart/table). Chart view: bar chart showing inflows (green) and outflows (red) by date, plus line chart showing cumulative cash position with running balance. Table view: chronological transaction list with date, type (In/Out with icons), category, description, amount, and running balance columns. Transaction types include item acquisitions (outflow), sales revenue (inflow), platform fees (outflow), and shipping costs (outflow). Hover tooltips show formatted currency values. Used same recharts Tooltip formatter pattern (Number(value)) as financial-charts.tsx.
- Timestamp: 2026-02-16
---

## US-058: Financial reporting: tax-ready export
- Status: COMPLETE
- Files changed: src/components/finances/financial-export.tsx (new), src/pages/finances.tsx, prd.json, scripts/ralph/prd.json
- Notes: Created FinancialExport component with date range selector (defaults to current tax year), dropdown menu with CSV and PDF export options. CSV export generates file with summary section (gross revenue, expenses by category, net profit) followed by transaction details (date, type, category, amount, item title, platform). PDF export opens a styled HTML document in a new window for browser print-to-PDF. Transactions are built from inventory items (acquisition expenses), sales (income + platform fees), and shipments (shipping costs). File naming follows gradethread_financial_report_{startDate}_{endDate}.csv convention. Used existing CSV escape pattern from submissions.tsx.
- Timestamp: 2026-02-16
---

## US-059: Analytics: time-on-market tracking
- Status: COMPLETE
- Files changed: src/pages/inventory.tsx, src/components/finances/time-on-market.tsx (new), src/pages/finances.tsx, prd.json, scripts/ralph/prd.json
- Notes: Updated inventory page to show "Days Listed" column calculated from earliest listing date to sale date (for sold items) or today (for active items), replacing the old "Days in Inventory" column. Added yellow highlighting for 30+ days and red for 60+ days. Created TimeOnMarket analytics component with: overall average days-to-sell metric, slowest category summary card, slow-moving items count card, time-to-sell distribution histogram (6 buckets), average days by garment type table, average days by brand table, and slow-moving inventory section showing unsold items listed 30+ days. Fetches listings and sales data in inventory page for the days-listed calculation. Used non-null assertion for array[0] access after .length check to satisfy tsc -b strict mode.
- Timestamp: 2026-02-16
---

## US-060: Analytics: price suggestion engine
- Status: COMPLETE
- Files changed: src/lib/price-suggestions.ts (new), src/pages/price-suggestions.tsx (new), src/pages/inventory-detail.tsx, src/routes/index.tsx, src/components/dashboard/sidebar.tsx, prd.json, scripts/ralph/prd.json
- Notes: Created price suggestion algorithm in src/lib/price-suggestions.ts with calculateSuggestedPrice function. Algorithm uses grade tier multipliers (NWT 1.3x down to Poor 0.6x), brand/category matching for comparable sales, grade-weighted averaging when sufficient data exists, and time-based reduction thresholds (14d: -7%, 30d: -15%, 60d: -25% with auction suggestion). Added callout card on inventory detail page with severity-colored left border (blue/yellow/red), showing current vs suggested price and adjustment percentage. Created full suggestions page at /dashboard/analytics/suggestions with summary cards (total items, urgent actions, warnings) and detailed table with all items sorted by severity. Added sidebar navigation item with Lightbulb icon.
- Timestamp: 2026-02-16
---

## US-061: Analytics: listing optimization suggestions
- Status: COMPLETE
- Files changed: src/components/analytics/listing-suggestions.tsx (new), src/pages/dashboard.tsx, src/pages/inventory-detail.tsx, prd.json, scripts/ralph/prd.json
- Notes: Created listing-suggestions.tsx with generateListingSuggestions engine producing three suggestion types: (1) add_platforms when item listed on only 1 platform, (2) price_adjustment when listed 14+ days without selling (severity escalates at 30d/60d), (3) regrade_photos when grade confidence < 0.75. Two display components exported: ListingSuggestions (card with list, used on dashboard with maxItems=5) and InventoryItemSuggestions (individual cards, used on inventory detail page). Dismissible suggestions stored in localStorage under gradethread_dismissed_suggestions key. Dashboard uses separate TanStack Query for inventory/listings/grade_reports data. tsc -b caught array index access issue requiring guard for activeListings[0].
- Timestamp: 2026-02-16
---

## US-062: Dispute submission form and tracking
- Status: COMPLETE
- Files changed: src/pages/submission-detail.tsx, src/pages/submissions.tsx, prd.json, scripts/ralph/prd.json
- Notes: Added Dispute Grade button on submission detail page (visible for completed grades within 7 days, hidden if dispute already exists). Dispute dialog with reason textarea (min 20 chars, character counter) and optional multi-photo upload for additional evidence. Creates dispute record linked to grade_report and user_id, updates submission status to 'disputed'. Dispute status card displayed on submission detail page with color-coded badge (open=yellow, under_review=blue, resolved=green, rejected=red), reason, resolution notes, and pending review message. My Disputes section added to submissions page with table showing submission title, status, reason, filed date, and resolution notes — clicking navigates to the submission detail. Used 'as GradeReportRow' cast for tsc -b compatibility. No new lint errors.
- Timestamp: 2026-02-18
---

## US-063: API key management page
- Status: COMPLETE
- Files changed: src/pages/api-keys.tsx, services/edge-functions/src/routes/api-keys.ts (new), services/edge-functions/src/main.ts, prd.json, scripts/ralph/prd.json
- Notes: Created edge function routes for API key CRUD at /api/keys with auth middleware. POST creates key with crypto.getRandomValues (32 bytes), SHA-256 hashing for storage, returns full key once. GET lists user's keys (id, name, prefix, dates). DELETE revokes by id with ownership check. Server-side plan gating (Professional/Enterprise only) and 10-key limit. Frontend page rebuilt with plan gate (Crown upgrade prompt for Free/Starter), TanStack Query for key list, create dialog with name + optional expiry date, one-time full key display with copy-to-clipboard and security warning, revoke confirmation dialog. Key format: gt_sk_{64 hex chars}, prefix shows first 14 chars. Fixed pre-existing tsc -b stale cache issue (recharts/qrcode.react types were resolvable but tsBuildInfo was stale).
- Timestamp: 2026-02-18
---

## US-064: Edge function: API key generation and validation
- Status: COMPLETE
- Files changed: services/edge-functions/src/middleware/api-key-auth.ts (new), services/edge-functions/src/main.ts, prd.json, scripts/ralph/prd.json
- Notes: Created api-key-auth.ts middleware that validates API keys from the X-API-Key header. Hashes the provided key with SHA-256 and matches against stored key_hash in api_keys table. Validates key format (gt_sk_ prefix + 64 hex chars = 70 chars total). Checks if key is expired via expires_at timestamp. Updates last_used_at as fire-and-forget (non-blocking) on successful validation. Sets user and userId on Hono context from the key's user_id, matching the same interface as the JWT auth middleware. Updated CORS configuration to allow X-API-Key header. POST/DELETE routes and key generation logic already existed from US-063.
- Timestamp: 2026-02-18
---

## US-065: Public REST API: grade submission and retrieval
- Status: COMPLETE
- Files changed: services/edge-functions/src/routes/api-v1.ts (new), services/edge-functions/src/main.ts, prd.json, scripts/ralph/prd.json
- Notes: Created api-v1.ts route file with 3 endpoints versioned under /api/v1/. POST /api/v1/grades accepts JSON body with garment info and images array (each image has image_type + url or base64), validates required fields and image types, downloads/decodes images, uploads to Supabase Storage, creates submission, triggers grading pipeline, returns 202 with { data: { id, status }, error: null, meta: null }. GET /api/v1/grades/:id returns full submission info with grade report (all factor scores, AI summary, certificate_id) for completed grades. GET /api/v1/grades returns paginated list with ?page=&limit=&status= query params, includes grade summary for completed items, returns meta with page/limit/total/total_pages/has_next/has_prev. All responses follow consistent { data, error, meta } JSON structure. Authenticated via X-API-Key header using apiKeyAuthMiddleware. Rate limited at 100 req/min via existing rateLimiter middleware. Plan limit checking and usage increment reuse same logic as internal grade routes.
- Timestamp: 2026-02-18
---

## US-066: Webhook delivery system for grade completion
- Status: COMPLETE
- Files changed: supabase/migrations/00005_api_keys_webhook_url.sql (new), services/edge-functions/src/lib/webhook-delivery.ts (new), services/edge-functions/src/routes/api-v1.ts, services/edge-functions/src/lib/grading-pipeline.ts, services/edge-functions/src/main.ts, src/types/database.ts, prd.json, scripts/ralph/prd.json
- Notes: Migration 00005 adds nullable webhook_url column to api_keys table and an UPDATE RLS policy. Created webhook-delivery.ts with notifyWebhooks() orchestrator, HMAC-SHA256 signature computation using key_hash as secret, retry logic with exponential backoff (5s, 30s, 120s = 3 retries after initial attempt), 10s delivery timeout, and comprehensive logging of all attempts/responses. PATCH /api/v1/webhook endpoint validates URL format (http/https), allows null to clear, and updates all user's API keys. Grading pipeline triggers notifyWebhooks as fire-and-forget after grade completion (Step 8). Added PATCH to CORS allowMethods. Updated ApiKeyRow and ApiKeyInsert types with webhook_url field. Typecheck and build pass clean.
- Timestamp: 2026-02-18
---

## US-067: Admin layout and role-based access control
- Status: COMPLETE
- Files changed: src/components/auth/admin-route.tsx (new), src/layouts/admin-layout.tsx (new), src/pages/admin/dashboard.tsx (new), src/pages/admin/users.tsx (new), src/pages/admin/submissions.tsx (new), src/pages/admin/reviews.tsx (new), src/pages/admin/ai-models.tsx (new), src/pages/admin/system.tsx (new), src/routes/index.tsx, src/components/dashboard/header.tsx, prd.json, scripts/ralph/prd.json
- Notes: AdminRoute guard component checks profile.role for 'admin' or 'super_admin', redirects non-admins to /dashboard with 'Access denied' toast (using useRef to prevent duplicate toasts), redirects unauthenticated to /login. AdminLayout uses brand-night (#1A1A2E) background for darker treatment distinct from dashboard's brand-navy sidebar. Active nav items use brand-red highlight instead of white. Admin header shows "Admin Panel" badge. "Back to Dashboard" link at sidebar bottom. Six placeholder admin pages created under src/pages/admin/. Routes wrapped in AdminRoute guard at /admin/*. Shield icon admin link added to dashboard header dropdown, only rendered when profile.role is admin or super_admin.
- Timestamp: 2026-02-18
---

## US-068: Admin dashboard with KPI overview
- Status: COMPLETE
- Files changed: src/pages/admin/dashboard.tsx, supabase/migrations/00006_admin_read_policies.sql (new), prd.json, scripts/ralph/prd.json
- Notes: Replaced placeholder admin dashboard with full implementation. 8 KPI cards in 2 rows: Primary row — Total Users, Active Subscribers, Submissions Today, Revenue This Month. Secondary row — Average Grade, Dispute Rate %, AI Accuracy % (high-confidence rate), Pending Reviews count. 3 line charts (recharts): Submission Volume (daily, 30 days, brand navy), Revenue (daily, 30 days, green), New Users (daily, 30 days, brand red). All data fetched from Supabase in parallel via Promise.all with admin RLS policies. Auto-refreshes every 60 seconds via TanStack Query refetchInterval. Created migration 00006 adding admin SELECT policies on users, submissions, grade_reports, disputes, and sales tables so admin users can query platform-wide data. Used same recharts patterns (Tooltip Number() cast, TOOLTIP_STYLE constant) as existing charts for consistency. Typecheck and build pass clean.
- Timestamp: 2026-02-18
---

## US-069: Admin: user management list and detail
- Status: COMPLETE
- Files changed: src/pages/admin/users.tsx, src/pages/admin/user-detail.tsx (new), src/routes/index.tsx, src/components/ui/alert-dialog.tsx (shadcn), prd.json, scripts/ralph/prd.json
- Notes: Rebuilt users.tsx from placeholder to full admin user management list. Table with 7 columns (name, email, plan, role, grades used, signup date, last active). Search by name or email, filter by plan/role/signup date range. Paginated at 20 rows. Click row navigates to /admin/users/:id. Created user-detail.tsx with profile card (avatar, name, email, plan, role, join date, Stripe ID), usage stats (4 metric cards), admin actions section with 3 controls (change plan dropdown, change role dropdown, suspend/unsuspend button), subscription info card, and submission history table (last 20 with status badges and grade scores). All admin actions create admin_audit_log entries with details object. AlertDialog confirmation for all destructive actions. Added shadcn alert-dialog component. Added route /admin/users/:id.
- Timestamp: 2026-02-18
---

## US-070: Admin: submission queue and monitoring
- Status: COMPLETE
- Files changed: src/pages/admin/submissions.tsx, prd.json, scripts/ralph/prd.json
- Notes: Rebuilt placeholder admin submissions page with full implementation. Table with 8 columns (title, user email, status badge, grade score, confidence %, date, processing time, actions). Search by title/email/name. Filters for status (5 options), confidence level (high/medium/low), and date range. Sortable by date, confidence, and processing time with toggle direction. 25-row pagination. Click row navigates to submission detail. Three admin actions per row: (1) View AI Raw Analysis dialog showing full grade report with scores, factor breakdown, AI summary, detailed notes JSON, and metadata; (2) Re-trigger Grading with AlertDialog confirmation that resets status to 'processing'; (3) Mark as Failed for stuck processing items. Dedicated Failed Submissions section with table showing failed items and re-trigger buttons. 5-minute SLA indicator: overdue processing items highlighted with red background, clock icon in status badge, red processing time text, and warning banner showing count of overdue items. All admin actions create audit log entries.
- Timestamp: 2026-02-18
---

## US-071: Admin: human review queue
- Status: COMPLETE
- Files changed: src/pages/admin/reviews.tsx, prd.json, scripts/ralph/prd.json, scripts/ralph/progress.txt
- Notes: Replaced placeholder with full human review queue implementation. Queue table shows submission title, garment type, AI overall score, confidence %, grade tier badge, and waiting time (with Clock icon). Filters: unreviewed-only vs all, confidence range (high/medium/low), and text search by title/email/name. Sort by waiting time (oldest first default) or confidence (lowest first). Review detail dialog shows: submitted photos grid with signed URLs from Supabase Storage (loading skeleton while fetching), AI grade and confidence cards, AI summary text, and editable factor scores (5 inputs with weight labels, AI original values shown, computed weighted overall with live delta display). Three reviewer actions: (1) Approve As-Is creates human_reviews record with original score unchanged, (2) Adjust & Approve creates human_reviews record with adjusted_score AND updates grade_report factor scores + overall, (3) Reject & Re-grade creates human_reviews record and resets submission to processing status. Score adjustments >1.5 points show amber warning banner; non-super_admin users have Adjust button disabled. Already-reviewed items show green info banner with previous review details. All actions logged to admin_audit_log with action/target/details. Stats badges in header show pending/reviewed/total counts. Pagination at 20 items per page. Typecheck and build pass clean.
- Timestamp: 2026-02-18
---
