# Ralph Progress Log
Started: 2026-02-16
Branch: ralph/gradethread-build
---

## Foundation (US-001 through US-021)
- Status: COMPLETE (pre-built before Ralph)
- 21 stories covering: Vite scaffold, Tailwind/shadcn, TypeScript types, Supabase client, auth layer, routing, layouts, dashboard shell, all pages, static assets, DB migration, edge functions, CF config
- Notes: Built manually in initial foundation session. All typecheck and build passing.
---

## US-022: Database migration: add inventory and financial tracking tables
- Status: COMPLETE
- Files changed: supabase/migrations/00002_inventory_financial.sql, prd.json, scripts/ralph/prd.json
- Notes: Created migration with 2 new enums (item_status, listing_platform), 4 new tables (inventory_items, listings, sales, shipments). All tables have UUID PKs, proper FK constraints (CASCADE on delete, SET NULL for optional refs), indexes on all FKs and status columns, RLS policies enforcing ownership through the inventory_items -> user_id chain, and set_updated_at triggers on tables with updated_at columns. Sales table intentionally has no updated_at (immutable records). Shipments RLS uses a JOIN through sales to inventory_items for ownership verification.
- Timestamp: 2026-02-16
---

## US-023: TypeScript types for inventory and financial tables
- Status: COMPLETE
- Files changed: src/types/database.ts, prd.json, scripts/ralph/prd.json
- Notes: Added ItemStatus (8 values) and ListingPlatform (8 values) enum types. Created Row, Insert, and Update types for inventory_items, listings, sales, and shipments tables. Updated Database interface with 4 new table entries in public.Tables and 2 new enum entries in public.Enums. All nullable SQL columns mapped to `T | null`. Insert types have optional fields for columns with DB defaults. Sales has no updated_at (immutable records per migration design). Typecheck and build pass clean.
- Timestamp: 2026-02-16
---

## US-024: Database migration: admin tables and roles
- Status: COMPLETE
- Files changed: supabase/migrations/00003_admin_tables.sql, src/types/database.ts, prd.json, scripts/ralph/prd.json
- Notes: Created user_role enum (user/reviewer/admin/super_admin), added role column to users table (default 'user'). Three new tables: admin_audit_log (for tracking admin actions), human_reviews (for reviewer overrides on low-confidence grades), ai_prompt_versions (for tracking AI prompt iterations and accuracy). Created is_admin() and is_reviewer_or_admin() SECURITY DEFINER helper functions for RLS. RLS policies: audit log admin-only, human reviews admin+reviewer, prompt versions admin-only (full CRUD). Added indexes on all FKs, action/target_type columns, and users.role. TypeScript types updated with UserRole enum, role on UserRow/UserInsert, and Row/Insert/Update types for all 3 new tables plus Database interface entries.
- Timestamp: 2026-02-16
---

## US-025: TypeScript types for admin tables
- Status: COMPLETE
- Files changed: scripts/ralph/prd.json, prd.json
- Notes: All acceptance criteria were already satisfied by the US-024 implementation which added UserRole enum, UserRow.role field, Row/Insert/Update types for admin_audit_log, human_reviews, and ai_prompt_versions, plus Database interface entries and UserRole enum registration. Verified typecheck and build pass. No code changes needed â€” only prd.json updates to mark story as passing.
- Timestamp: 2026-02-16
---

## US-026: Image upload utility with Supabase Storage
- Status: COMPLETE
- Files changed: src/lib/storage.ts, prd.json, scripts/ralph/prd.json, scripts/ralph/progress.txt
- Notes: Created storage utility module with three exported functions: uploadSubmissionImage (validates file type/size, uploads to {userId}/{submissionId}/{imageType}_{timestamp}.{ext}), getImageUrl (creates signed URLs with 1hr expiry), deleteSubmissionImage (removes files from bucket). Validates against MIME types (jpeg/png/webp) and 10MB size limit matching the DB bucket config. All errors throw with meaningful messages. Typecheck and build pass clean.
- Timestamp: 2026-02-16
---

## US-027: Client-side image compression and validation
- Status: COMPLETE
- Files changed: src/lib/image-utils.ts, prd.json, scripts/ralph/prd.json, scripts/ralph/progress.txt
- Notes: Created image-utils module with two exported functions: validateImage(file) checks MIME type (jpeg/png/webp), file size (10MB max), and resolution (min 1200x1200px), returning structured validation errors with user-friendly messages. compressImage(file, maxWidth, quality) uses canvas API to resize images (default max 2400px wide), compress (default 0.85 quality), and correct EXIF orientation by parsing the orientation tag from the first 64KB of JPEG files. Handles all 8 EXIF orientation values including dimension swaps for rotated images. Outputs WebP for JPEG/WebP inputs, preserves PNG format. Typecheck and build pass clean.
- Timestamp: 2026-02-16
---

## US-028: Edge function: JWT auth middleware
- Status: COMPLETE
- Files changed: services/edge-functions/src/middleware/auth.ts, services/edge-functions/src/main.ts, prd.json, scripts/ralph/prd.json, scripts/ralph/progress.txt
- Notes: Created Hono middleware that extracts Bearer token from Authorization header, validates it via supabase.auth.getUser(), and sets user and userId on the Hono context. Returns 401 JSON error for missing or invalid tokens. Applied to /api/grade/* routes in main.ts using app.use() path matching. Health and webhook routes remain unprotected as required. Uses createMiddleware from hono/factory with typed Variables for user and userId.
- Timestamp: 2026-02-16
---

## US-029: Edge function: rate limiting middleware
- Status: COMPLETE
- Files changed: services/edge-functions/src/middleware/rate-limit.ts, services/edge-functions/src/main.ts, prd.json, scripts/ralph/prd.json, scripts/ralph/progress.txt
- Notes: Created rateLimiter(maxRequests, windowMs) factory function that returns Hono middleware. Uses in-memory Map keyed by userId from auth context. Tracks request count and window reset time per user. Returns 429 with Retry-After header and JSON error body when limit exceeded. Includes periodic cleanup of expired entries (every 5 minutes). Adds standard X-RateLimit-Limit, X-RateLimit-Remaining, and X-RateLimit-Reset headers to all responses. Applied to /api/grade/* routes after auth middleware with default 60 requests per 60 seconds. Skips rate limiting if no userId is available in context.
- Timestamp: 2026-02-16
---

## US-030: Photo upload UI component with drag-and-drop
- Status: COMPLETE
- Files changed: src/components/submission/photo-upload.tsx, prd.json, scripts/ralph/prd.json, scripts/ralph/progress.txt
- Notes: Created PhotoUpload component with 8 upload slots (front, back, label, detail required; detail 2, defect 1-3 optional). Each slot shows icon (Shirt/Tag/Search/AlertTriangle from lucide-react), label, required indicator, and description. Supports drag-and-drop (onDragOver/onDrop) and click-to-select (hidden file input). Shows image preview with hover-reveal remove button. Validates via existing validateImage (type/size/resolution) and compresses via compressImage before emitting. Emits onChange with PhotoUploadItem[] ({file, imageType, preview}). Responsive grid: 2 cols mobile, 4 cols desktop. Used Map<string, SlotState> instead of Record for strict TypeScript compatibility. Processing spinner shown during validation/compression.
- Timestamp: 2026-02-16
---
