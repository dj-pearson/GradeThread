# Ralph Progress Log
Started: 2026-02-16
Branch: ralph/gradethread-build
---

## Foundation (US-001 through US-021)
- Status: COMPLETE (pre-built before Ralph)
- 21 stories covering: Vite scaffold, Tailwind/shadcn, TypeScript types, Supabase client, auth layer, routing, layouts, dashboard shell, all pages, static assets, DB migration, edge functions, CF config
- Notes: Built manually in initial foundation session. All typecheck and build passing.
---

## US-022: Database migration: add inventory and financial tracking tables
- Status: COMPLETE
- Files changed: supabase/migrations/00002_inventory_financial.sql, prd.json, scripts/ralph/prd.json
- Notes: Created migration with 2 new enums (item_status, listing_platform), 4 new tables (inventory_items, listings, sales, shipments). All tables have UUID PKs, proper FK constraints (CASCADE on delete, SET NULL for optional refs), indexes on all FKs and status columns, RLS policies enforcing ownership through the inventory_items -> user_id chain, and set_updated_at triggers on tables with updated_at columns. Sales table intentionally has no updated_at (immutable records). Shipments RLS uses a JOIN through sales to inventory_items for ownership verification.
- Timestamp: 2026-02-16
---

## US-023: TypeScript types for inventory and financial tables
- Status: COMPLETE
- Files changed: src/types/database.ts, prd.json, scripts/ralph/prd.json
- Notes: Added ItemStatus (8 values) and ListingPlatform (8 values) enum types. Created Row, Insert, and Update types for inventory_items, listings, sales, and shipments tables. Updated Database interface with 4 new table entries in public.Tables and 2 new enum entries in public.Enums. All nullable SQL columns mapped to `T | null`. Insert types have optional fields for columns with DB defaults. Sales has no updated_at (immutable records per migration design). Typecheck and build pass clean.
- Timestamp: 2026-02-16
---

## US-024: Database migration: admin tables and roles
- Status: COMPLETE
- Files changed: supabase/migrations/00003_admin_tables.sql, src/types/database.ts, prd.json, scripts/ralph/prd.json
- Notes: Created user_role enum (user/reviewer/admin/super_admin), added role column to users table (default 'user'). Three new tables: admin_audit_log (for tracking admin actions), human_reviews (for reviewer overrides on low-confidence grades), ai_prompt_versions (for tracking AI prompt iterations and accuracy). Created is_admin() and is_reviewer_or_admin() SECURITY DEFINER helper functions for RLS. RLS policies: audit log admin-only, human reviews admin+reviewer, prompt versions admin-only (full CRUD). Added indexes on all FKs, action/target_type columns, and users.role. TypeScript types updated with UserRole enum, role on UserRow/UserInsert, and Row/Insert/Update types for all 3 new tables plus Database interface entries.
- Timestamp: 2026-02-16
---

## US-025: TypeScript types for admin tables
- Status: COMPLETE
- Files changed: scripts/ralph/prd.json, prd.json
- Notes: All acceptance criteria were already satisfied by the US-024 implementation which added UserRole enum, UserRow.role field, Row/Insert/Update types for admin_audit_log, human_reviews, and ai_prompt_versions, plus Database interface entries and UserRole enum registration. Verified typecheck and build pass. No code changes needed — only prd.json updates to mark story as passing.
- Timestamp: 2026-02-16
---

## US-026: Image upload utility with Supabase Storage
- Status: COMPLETE
- Files changed: src/lib/storage.ts, prd.json, scripts/ralph/prd.json, scripts/ralph/progress.txt
- Notes: Created storage utility module with three exported functions: uploadSubmissionImage (validates file type/size, uploads to {userId}/{submissionId}/{imageType}_{timestamp}.{ext}), getImageUrl (creates signed URLs with 1hr expiry), deleteSubmissionImage (removes files from bucket). Validates against MIME types (jpeg/png/webp) and 10MB size limit matching the DB bucket config. All errors throw with meaningful messages. Typecheck and build pass clean.
- Timestamp: 2026-02-16
---

## US-027: Client-side image compression and validation
- Status: COMPLETE
- Files changed: src/lib/image-utils.ts, prd.json, scripts/ralph/prd.json, scripts/ralph/progress.txt
- Notes: Created image-utils module with two exported functions: validateImage(file) checks MIME type (jpeg/png/webp), file size (10MB max), and resolution (min 1200x1200px), returning structured validation errors with user-friendly messages. compressImage(file, maxWidth, quality) uses canvas API to resize images (default max 2400px wide), compress (default 0.85 quality), and correct EXIF orientation by parsing the orientation tag from the first 64KB of JPEG files. Handles all 8 EXIF orientation values including dimension swaps for rotated images. Outputs WebP for JPEG/WebP inputs, preserves PNG format. Typecheck and build pass clean.
- Timestamp: 2026-02-16
---

## US-028: Edge function: JWT auth middleware
- Status: COMPLETE
- Files changed: services/edge-functions/src/middleware/auth.ts, services/edge-functions/src/main.ts, prd.json, scripts/ralph/prd.json, scripts/ralph/progress.txt
- Notes: Created Hono middleware that extracts Bearer token from Authorization header, validates it via supabase.auth.getUser(), and sets user and userId on the Hono context. Returns 401 JSON error for missing or invalid tokens. Applied to /api/grade/* routes in main.ts using app.use() path matching. Health and webhook routes remain unprotected as required. Uses createMiddleware from hono/factory with typed Variables for user and userId.
- Timestamp: 2026-02-16
---

## US-029: Edge function: rate limiting middleware
- Status: COMPLETE
- Files changed: services/edge-functions/src/middleware/rate-limit.ts, services/edge-functions/src/main.ts, prd.json, scripts/ralph/prd.json, scripts/ralph/progress.txt
- Notes: Created rateLimiter(maxRequests, windowMs) factory function that returns Hono middleware. Uses in-memory Map keyed by userId from auth context. Tracks request count and window reset time per user. Returns 429 with Retry-After header and JSON error body when limit exceeded. Includes periodic cleanup of expired entries (every 5 minutes). Adds standard X-RateLimit-Limit, X-RateLimit-Remaining, and X-RateLimit-Reset headers to all responses. Applied to /api/grade/* routes after auth middleware with default 60 requests per 60 seconds. Skips rate limiting if no userId is available in context.
- Timestamp: 2026-02-16
---

## US-030: Photo upload UI component with drag-and-drop
- Status: COMPLETE
- Files changed: src/components/submission/photo-upload.tsx, prd.json, scripts/ralph/prd.json, scripts/ralph/progress.txt
- Notes: Created PhotoUpload component with 8 upload slots (front, back, label, detail required; detail 2, defect 1-3 optional). Each slot shows icon (Shirt/Tag/Search/AlertTriangle from lucide-react), label, required indicator, and description. Supports drag-and-drop (onDragOver/onDrop) and click-to-select (hidden file input). Shows image preview with hover-reveal remove button. Validates via existing validateImage (type/size/resolution) and compresses via compressImage before emitting. Emits onChange with PhotoUploadItem[] ({file, imageType, preview}). Responsive grid: 2 cols mobile, 4 cols desktop. Used Map<string, SlotState> instead of Record for strict TypeScript compatibility. Processing spinner shown during validation/compression.
- Timestamp: 2026-02-16
---

## US-031: Submission wizard: step 1 - garment info form
- Status: COMPLETE
- Files changed: src/components/submission/garment-info-form.tsx, src/components/ui/select.tsx (shadcn), src/components/ui/textarea.tsx (shadcn), prd.json, scripts/ralph/prd.json
- Notes: Created GarmentInfoForm component with garment type select (GARMENT_TYPES), category select (GARMENT_CATEGORIES filtered by type via CATEGORY_BY_TYPE mapping), brand input (optional), title input (required, max 100 chars with counter), description textarea (optional, max 500 chars with counter). Form validation shows inline error messages for required fields. onSubmit passes validated GarmentInfo to parent. Supports defaultValues prop for state persistence. Added shadcn select and textarea components via npx shadcn@latest add.
- Timestamp: 2026-02-16
---

## US-032: Submission wizard: multi-step container with progress
- Status: COMPLETE
- Files changed: src/pages/new-submission.tsx (new), src/routes/index.tsx, prd.json, scripts/ralph/prd.json
- Notes: Created 3-step submission wizard at /dashboard/submissions/new. StepIndicator component shows numbered circles with checkmarks for completed steps and connecting lines. Step 1 renders GarmentInfoForm with defaultValues for state persistence when navigating back. Step 2 renders PhotoUpload with Back/Next buttons (Next disabled until all 4 required photos uploaded). Step 3 shows review with garment details grid, photo thumbnails grid, and pricing info from user's plan. All state (garmentInfo, photos) persisted in parent component via useState so navigating back preserves data. Route added to router inside protected dashboard layout.
- Timestamp: 2026-02-16
---

## US-033: Submission creation API endpoint
- Status: COMPLETE
- Files changed: services/edge-functions/src/routes/grade.ts, supabase/migrations/00004_increment_grades_function.sql, prd.json, scripts/ralph/prd.json
- Notes: Fully implemented POST /api/grade/submit endpoint with multipart form data parsing. Validates garment_type, garment_category, title (required), and image files (requires front, back, label, and at least 1 detail image). Checks user's grade usage against plan limits (free:5, starter:50, professional:500, enterprise:unlimited) with monthly reset logic. Creates submission record with status 'pending', uploads each image to Supabase storage under {userId}/{submissionId}/{imageType}_{timestamp}.{ext}, creates submission_image records with display_order. Increments grades_used_this_month via Postgres RPC function (new migration 00004) or resets counter if month rolled over. Returns 201 with { submissionId, status } on success, 403 with upgrade message if limit exceeded, 400 with detailed validation errors for invalid input. Also implemented GET /status/:id endpoint scoped to authenticated user. Includes cleanup logic on failure (deletes uploaded images and submission record).
- Timestamp: 2026-02-16
---

## US-034: Claude Vision API integration for per-image analysis
- Status: COMPLETE
- Files changed: services/edge-functions/src/lib/ai-grading.ts (new), prd.json, scripts/ralph/prd.json
- Notes: Created ai-grading.ts module exporting analyzeImage(imageUrl, imageType, garmentType) function and typed interfaces (PerImageAnalysis, DetectedIssue, ConditionSignal, FactorScores). Uses Anthropic SDK v0.24.1 with base64 image source (parseImageInput helper handles data URI and raw base64 formats). System prompt establishes expert clothing condition assessor role with grading scale and 5 weighted factors. User prompt includes image-type-specific context (front/back/label/detail/defect) and garment-type-specific criteria (tops/bottoms/outerwear/dresses/footwear/accessories). Requests structured JSON with detected_issues[], condition_signals[], and estimated_scores per factor. Response parsing strips markdown code fences, validates structure, and clamps scores to 1.0-10.0 range. Error handling covers timeouts, rate limits, and parse failures with contextual error messages. Logs API usage (input/output tokens, latency) for monitoring.
- Timestamp: 2026-02-16
---

## US-035: Claude Vision API: composite grading from all images
- Status: COMPLETE
- Files changed: services/edge-functions/src/lib/ai-grading.ts, prd.json, scripts/ralph/prd.json
- Notes: Added compositeGrade(perImageResults[], garmentInfo) function to ai-grading.ts. Exports new types: CompositeGradeResult, GarmentInfo, DefectFound. Sends all per-image analyses as structured JSON input to Claude with comprehensive composite system prompt including full grade tier definitions (NWT through Salvage with score ranges and descriptions). Applies factor weights (fabric 30%, structural 25%, cosmetic 20%, functional 15%, odor 10%) and recalculates weighted average server-side for authoritative scoring. Rounds overall_score to nearest 0.5 increment. Derives grade_tier deterministically from calculated score via scoreToGradeTier(). Validates and clamps all factor scores (1.0-10.0), confidence (0.0-1.0). Sets needs_human_review flag when confidence < 0.75. Includes prompt_version field ("composite_v1") referencing ai_prompt_versions concept. Validates defects_found array entries for required fields and valid severity values. Comprehensive error handling for timeouts, rate limits, and parse failures with API usage logging.
- Timestamp: 2026-02-16
---

## US-036: Grade calculation and report creation pipeline
- Status: COMPLETE
- Files changed: services/edge-functions/src/lib/grading-pipeline.ts (new), prd.json, scripts/ralph/prd.json
- Notes: Created processSubmission(submissionId) orchestration function that runs the full grading pipeline. Fetches submission record and validates status is 'pending', sets status to 'processing'. Fetches associated submission_images, downloads each from Supabase Storage, converts Blob to base64 data URI with correct MIME type detection from file extension. Runs analyzeImage() on all images in parallel via Promise.all. Runs compositeGrade() with per-image results and garment info. Creates grade_report record with all factor scores, AI summary, confidence score, model version, and a UUID certificate_id generated via crypto.randomUUID(). Builds detailed_notes object from per-image issue/signal summaries plus defects summary. Updates submission status to 'completed' on success. Full try/catch wraps entire pipeline — on failure, logs error and updates submission status to 'failed' (with nested try/catch to handle status update failures). Comprehensive console logging at each pipeline stage with timing metrics.
- Timestamp: 2026-02-16
---

## US-037: Trigger grading pipeline on submission creation
- Status: COMPLETE
- Files changed: services/edge-functions/src/routes/grade.ts, services/edge-functions/src/lib/grading-pipeline.ts, prd.json, scripts/ralph/prd.json
- Notes: Updated POST /api/grade/submit to set status to 'processing' after image upload and trigger processSubmission() as fire-and-forget with .catch() error handler. Response now returns status 'processing' instead of 'pending'. Updated GET /api/grade/status/:id to return { id, status, grade_report, created_at, updated_at } — fetches from grade_reports table when status is 'completed', returns null otherwise. Updated processSubmission() to accept both 'pending' and 'processing' statuses (since submit endpoint now sets 'processing' before calling the pipeline). Typecheck and build pass clean.
- Timestamp: 2026-02-16
---

## US-038: Submission detail page with grade report display
- Status: COMPLETE
- Files changed: src/pages/submission-detail.tsx, src/components/ui/skeleton.tsx (shadcn), src/components/ui/progress.tsx (shadcn), prd.json, scripts/ralph/prd.json
- Notes: Fully rebuilt submission-detail.tsx from placeholder to complete grade report page. Features: loading skeleton while fetching, garment info card (title/brand/type/category), large circular overall score with color-coded tier badge (green >7, yellow 5-7, red <5), factor breakdown with 5 labeled progress bars showing weights, AI analysis summary card, confidence indicator (high/medium/low with icons), detected issues as badges or bullet points from detailed_notes, image gallery with signed URLs from Supabase Storage, share certificate button linking to /cert/:certificateId, status-aware states (processing spinner, failed error, pending info). Added shadcn skeleton and progress components. Used type assertion for submission_images query due to tsc -b type inference resolving data to 'never' despite correct Database interface definition.
- Timestamp: 2026-02-16
---

## US-039: Submissions list page with filtering and pagination
- Status: COMPLETE
- Files changed: src/pages/submissions.tsx, src/components/ui/table.tsx (shadcn), prd.json, scripts/ralph/prd.json
- Notes: Replaced placeholder submissions page with full implementation. Table displays title, brand, status badge (color-coded), grade score (with color), and date submitted. Filter controls for status (all/pending/processing/completed/failed/disputed) and garment type (all 6 types). Sort by date (default newest first) or grade with toggle direction. Pagination with 20 items per page, page number display, previous/next buttons. Click row navigates to /dashboard/submissions/:id. Empty state with CTA button to create first submission. Loading skeleton while fetching. Uses TanStack Query with queryKey including all filter/sort/page params and 5-minute stale time. Fetches grade reports for completed submissions in a second query and merges results. Type assertions used for Supabase query results due to tsc -b type resolution issue.
- Timestamp: 2026-02-16
---

## US-040: Stripe checkout session creation for grade payments
- Status: COMPLETE
- Files changed: services/edge-functions/src/routes/payments.ts (new), services/edge-functions/src/main.ts, scripts/ralph/prd.json, prd.json
- Notes: Created new payments route file with POST /checkout-session endpoint. Accepts { submissionId, tier } JSON body. Three tiers: standard ($2.99/299 cents), premium ($7.99/799 cents), express ($12.99/1299 cents). Validates tier is valid, validates user owns the submission via Supabase query. Creates Stripe Checkout Session with mode:payment, price_data with product name/description, and metadata containing submission_id, user_id, and tier for webhook processing. Success URL redirects to /dashboard/submissions/:id?payment=success, cancel URL to /dashboard/submissions?payment=cancelled. Returns { sessionId, url }. Registered route in main.ts at /api/payments with auth middleware applied.
- Timestamp: 2026-02-16
---

## US-041: Stripe webhook handling for payment events
- Status: COMPLETE
- Files changed: services/edge-functions/src/routes/webhooks.ts, scripts/ralph/prd.json, prd.json
- Notes: Replaced stub webhook handler with full Stripe webhook implementation. Verifies webhook signature using stripe.webhooks.constructEvent with STRIPE_WEBHOOK_SECRET env var. Handles 4 event types: (1) checkout.session.completed — reads submission_id/user_id from session metadata, marks submission payment_status as paid, triggers grading pipeline fire-and-forget; (2) customer.subscription.created/updated — finds user by stripe_customer_id, maps subscription to plan tier via metadata/lookup_key/price amount, updates user plan; (3) customer.subscription.deleted — downgrades user to free plan; (4) invoice.payment_failed — logs event with user context for debugging. Returns 200 for all handled events (including handler errors to prevent retries), 400 for signature verification failures. All events logged with [Webhook] prefix.
- Timestamp: 2026-02-16
---

## US-042: Subscription management page (billing)
- Status: COMPLETE
- Files changed: src/pages/billing.tsx, services/edge-functions/src/routes/payments.ts, scripts/ralph/prd.json, prd.json
- Notes: Fully rebuilt billing.tsx with plan comparison grid showing all 4 plans (Free, Starter $29/mo, Professional $99/mo, Enterprise custom). Current plan card shows feature list, usage progress bar (grades used / limit), and grade reset date with CalendarClock icon. Current plan highlighted with border-brand-navy border. Upgrade buttons call POST /api/payments/subscribe to create Stripe Checkout subscription sessions. Manage Subscription button calls POST /api/payments/portal to open Stripe Customer Portal for existing subscribers with stripe_customer_id. Enterprise plan directs to sales email. Added two new edge function endpoints: /subscribe (creates subscription checkout with existing customer or customer_email) and /portal (creates billing portal session). Downgrade handled via portal. All loading states with Loader2 spinner, errors via sonner toast.
- Timestamp: 2026-02-16
---

## US-043: Grade certificate public page
- Status: COMPLETE
- Files changed: src/pages/certificate.tsx, package.json, package-lock.json, scripts/ralph/prd.json, prd.json
- Notes: Fully rebuilt certificate.tsx as a public-facing grade certificate page. Fetches grade report by certificate_id via Supabase (public RLS). Shows GradeThread branding header with logo_white.svg and Shield icon. Displays overall score in a large circle with tier badge and color coding. Shows garment photos in a responsive grid gallery with signed URLs. Factor breakdown with 5 horizontal Progress bars matching submission-detail patterns. AI summary section. Footer with graded date (Calendar icon), model version (Cpu icon), certificate ID. QR code via qrcode.react (QRCodeSVG) linking back to the certificate URL in brand navy color. OG meta tags set dynamically via useEffect. Loading skeleton and "Certificate not found" error state. Mobile-responsive layout throughout.
- Timestamp: 2026-02-16
---

## US-044: Dashboard overview: live data integration
- Status: COMPLETE
- Files changed: src/pages/dashboard.tsx, prd.json, scripts/ralph/prd.json
- Notes: Replaced placeholder dashboard with live data integration. Fetches real submission count and last 5 recent submissions from Supabase via TanStack Query (5-min stale time). Recent submissions show title, date, status badge (color-coded), and grade score for completed items. Clicking a submission navigates to /dashboard/submissions/:id. Added "New Submission" CTA button in header linking to /dashboard/submissions/new. "View All" button links to submissions list. Empty state with CTA when no submissions exist. Total Submissions card shows live count with loading skeleton. Grades Used card already uses live profile data (grades_used_this_month). Grade reports fetched for completed submissions and merged. Type assertions used for Supabase query results per tsc -b workaround.
- Timestamp: 2026-02-16
---

## US-045: Grade analytics charts on dashboard
- Status: COMPLETE
- Files changed: src/components/dashboard/grade-charts.tsx (new), src/pages/dashboard.tsx, package.json, package-lock.json, prd.json, scripts/ralph/prd.json
- Notes: Installed recharts library. Created GradeCharts component with 3 charts: (1) Grade Distribution bar chart showing count of grades in each tier bucket (NWT through Poor) with color-coded bars, (2) Average Grade Over Time line chart with 4 weekly data points over last 30 days using brand navy color, (3) Submissions by Garment Type donut pie chart with labels showing percentages. All charts use ResponsiveContainer for responsive sizing. Empty state shows centered message when no completed submissions exist. Loading state shows skeleton cards. Integrated into dashboard.tsx between stats cards and recent submissions. Fixed tsc -b strict type issues: Record indexing returns possibly-undefined values, recharts Tooltip formatter type incompatibility, and Pie label percent possibly undefined.
- Timestamp: 2026-02-16
---

## US-046: Export submissions as CSV
- Status: COMPLETE
- Files changed: src/pages/submissions.tsx, prd.json, scripts/ralph/prd.json
- Notes: Added Export CSV button (with Download icon) to submissions page header alongside New Submission button. Export function fetches all user submissions and their grade reports from Supabase (bypassing pagination), then builds a CSV with 14 columns: Submission Date, Title, Brand, Garment Type, Category, Status, Overall Grade, Grade Tier, Fabric Condition, Structural Integrity, Cosmetic Appearance, Functional Elements, Odor & Cleanliness, Certificate URL. CSV fields properly escaped for commas/quotes/newlines. File downloads as gradethread_export_{YYYY-MM-DD}.csv via Blob URL. Shows loading state on button during export. Empty submissions show info toast. Fixed tsc -b type issue by using .slice(0,10) instead of .split('T')[0] and explicit string[] array typing.
- Timestamp: 2026-02-16
---

## US-047: Settings page: profile editing
- Status: COMPLETE
- Files changed: src/pages/settings.tsx, src/hooks/use-auth.ts, prd.json, scripts/ralph/prd.json
- Notes: Rewrote settings page with full profile editing: editable full name input, avatar upload with FileReader preview and Supabase storage upload, read-only email display, save button that updates users table via .update(). Password change section for email/password users (hidden for OAuth) with current password verification via re-auth, new password + confirm fields, min 6 chars validation. Added refreshProfile() to useAuth hook to reload profile after save. Used 'as never' cast on .update() to work around tsc -b type resolution issue. All toasts via sonner.
- Timestamp: 2026-02-16
---
